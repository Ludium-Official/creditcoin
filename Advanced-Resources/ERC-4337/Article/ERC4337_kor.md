# 그림 넣어고 내용 약간 읽기 쉽게 재수정 필요!!


# ERC-4337 : 계정 추상화(Account Abstraction)의 진화

## 1. 들어가며 — ERC란 무엇인가?

이더리움 생태계는 다양한 기능을 확장하고자 지속적으로 새로운 제안이 이루어지고 있다. 이때 커뮤니티에서 어떤 새로운 기능이나 규격을 제안할 때 사용하는 형식이 바로 "ERC(Ethereum Request for Comment)"이다.

ERC는 말 그대로 “이더리움에 대한 의견 요청”이라는 뜻을 가진다. 개발자, 연구자, 기업 등 누구나 이더리움 생태계에 필요한 새로운 기능을 제안하고, 그 내용을 기반으로 커뮤니티의 피드백을 받아 "공식 표준(EIP)으로 채택"될 수 있다.

아래와 같은 ERC들은 이더리움의 확장성과 사용성을 획기적으로 높인 주역들이다.

* "ERC-20" :  이더리움 상의 모든 대체 가능한 토큰(Fungible Token)의 기본이 되는 규격으로, 수많은 디파이(DeFi) 프로젝트와 ICO에서 활용됨
* "ERC-721" :  대체 불가능한 토큰(NFT)의 표준으로, 디지털 아트, 게임 아이템, 메타버스 자산과 같은 고유한 디지털 자산을 다룰 수 있게 만든 핵심 기술

이러한 맥락에서 ERC-4337도 단순한 기능 확장을 넘어서, 이더리움 지갑과 트랜잭션 처리 방식에 혁신적인 전환을 가져올 수 있는 제안이 될 수 있다.

---

## 2. Ethereum의 계정 구조: EOA와 CA

이더리움은 기본적으로 두 가지 종류의 계정을 가지고 있다. 바로 "EOA(Externally Owned Account)"와 "CA(Contract Account)"이다. 이 둘은 이더리움 생태계 내에서 트랜잭션을 처리하고 자산을 보관하는 기본 단위지만, 작동 방식과 특징에서 큰 차이를 가진다.

### 2.1 EOA (Externally Owned Account)

EOA는 말 그대로 “외부 소유 계정”이다. 사용자가 "개인키(Private Key)"를 통해 직접 제어하는 계정이며, 우리가 흔히 말하는 "메타마스크 지갑", "하드웨어 월렛" 등이 모두 EOA에 해당한다.

EOA는 다음과 같은 특징을 가진다

* "트랜잭션을 직접 발생"시킬 수 있다. 즉, 사용자가 지갑을 통해 송금, 스마트 컨트랙트 호출 등을 수행할 수 있음
* "개인키만 있으면" 언제 어디서든 해당 지갑을 복원하고 사용할 수 있음
* 하지만 단점도 명확하다. 예를 들어 "개인키를 분실할 경우 자산 복구가 불가능"하다. 지갑 복구 기능이 없기 때문에, 사용자 실수에 의한 자산 손실이 자주 발생함
* "가스비(Gas Fee)는 반드시 본인이 직접 ETH로 지불"해야 한다. ETH 잔고가 없으면 아무런 동작도 수행할 수 없음

이처럼 EOA는 단순하고 직관적이지만, 사용자 경험(UX) 측면에서는 "진입 장벽이 높은 구조"를 가지고 있다.

### 2.2 CA (Contract Account)

CA는 "스마트 컨트랙트 코드가 배포된 계정"이다. 사용자가 제어하는 게 아니라, 이더리움 블록체인에 고정된 로직에 의해 동작한다.

CA의 특징은 다음과 같다:

* 외부(EOA 또는 다른 컨트랙트)로부터 "트랜잭션을 수신받아야만 동작"한다. 자체적으로 트랜잭션을 만들 수는 없음
* 내부에 작성된 "스마트 컨트랙트 코드에 따라 자동으로 로직을 실행"함
* 조건부 송금, DAO 운영, 토큰 발행 등 복잡한 논리를 처리할 수 있으며, 유니스왑 V3와 같은 AMM도 이러한 컨트랙트 계정을 기반으로 동작함

이처럼 CA는 "다양한 비즈니스 로직을 담을 수 있는 계정"으로서 유연성을 제공하지만, "자체적으로 트랜잭션을 발생"시키는 기능은 없음.

---

## 3. 왜 계정 추상화(Account Abstraction)가 필요한가?

EOA와 CA는 각각 장단점이 명확하다. 하지만 이 둘을 함께 사용하는 데에는 여러 문제점이 존재한다. 특히 "사용자 경험(UX) 관점에서의 불편함"은 이더리움의 대중화에 큰 장애가 된다.

예를 들어

* 신규 사용자는 "개인키, 가스비, 지갑 연결" 같은 개념에 익숙하지 않기 때문에 Web3 서비스를 제대로 체험하기 어려움
* 가스비를 본인이 직접 지불해야 하기 때문에, "ETH가 없으면 아무 것도 할 수 없는 구조"임
* 자산 복구 기능이 없으며, 수수료 대납 등의 기능도 구현이 어려움
* 스마트 컨트랙트 기능은 강력하지만, "트랜잭션을 스스로 만들 수 없다"는 점에서 수동적임

이러한 문제를 해결하고자 등장한 개념이 바로 "Account Abstraction (계정 추상화)"이다.

---

# ERC-4337  : 계정 추상화를 위한 제안들

## 4. Account Abstraction: EOA와 CA의 경계를 허물다

앞선 내용에서 설명했듯, 이더리움에는 EOA와 CA라는 두 종류의 계정이 존재한다. 하지만 이들은 기능적으로 "서로를 보완할 수 있음에도 불구하고 완전히 분리된 구조"를 가지고 있다. 이로 인해 생기는 UX의 한계, 가스비 지불 문제, 복잡한 접근 방식 등은 Web3의 대중화를 가로막는 큰 장벽이 되고 있다.

이를 해결하기 위해 등장한 개념이 바로 "Account Abstraction (계정 추상화)"이다.
계정 추상화란 간단히 말해, 기존에 존재하던 "EOA와 CA의 구분을 없애고", 모든 계정을 스마트 컨트랙트처럼 동작하게 하자는 아이디어이다.

### 왜 모든 계정을 스마트 컨트랙트처럼 만들고자 하는가?

스마트 컨트랙트처럼 계정을 설계하면, 다음과 같은 기능을 계정 자체에 내장할 수 있게 된다:

| 기존 EOA에서 불가능한 기능 | Account Abstraction에서 가능한 기능 |
| ---------------- | ---------------------------- |
| 일일 송금 한도 제한 없음   | 하루 송금 최대 금액 설정 가능            |
| 자동 이체 불가능        | 매달 25일 자동 송금 가능              |
| 키 분실 시 자산 복구 불가  | 소셜 리커버리 기반 복구 가능             |
| 가스비 본인 부담만 가능    | 다른 사용자가 대납 가능                |

이러한 기능은 전통적인 은행 계좌에서는 당연하게 제공되는 기능이다. 하지만 이더리움 EOA에서는 구현 자체가 불가능하다. 따라서 "계정 추상화는 Web2 수준의 UX를 Web3에 도입하기 위한 핵심 수단"이라고 볼 수 있다.

---

## 5. Account Abstraction을 실현하려는 세 가지 제안

계정 추상화를 실현하기 위한 기술적 시도는 2017년부터 이어져 왔다. 현재까지 다음과 같은 세 가지 주요 제안이 존재한다:

1. "EIP-86 (2017)"
2. "ERC-2938 (2020)"
3. "ERC-4337 (2021)"

각 제안은 계정 추상화를 다르게 접근하며, 그 목표는 같지만 "구현 방식과 프로토콜 변경 여부"에서 큰 차이를 보인다.

---

## 6. EIP-86 (2017): 최초의 계정 추상화 제안

### 개요

* 제안자: "비탈릭 부테린 (Vitalik Buterin)"
* 제안명: EIP-86
* 목표: 사용자의 지갑을 스마트 컨트랙트처럼 동작하게 만들자는 아이디어

EIP-86은 "계정의 행동 방식 자체를 변경"하는 급진적인 접근을 택했다. 지갑이 단순히 서명하고 전송만 하는 구조가 아니라, "커스텀 로직을 실행할 수 있는 구조로 바꾸자"는 것이다.

예를 들어, "하루에 최대 10ETH까지만 송금 가능"이라는 제약을 지갑 안에 코드로 직접 정의할 수 있다면, 사용자는 "더 안전한 지갑 환경"을 만들 수 있다.

### 문제점

하지만 이 제안은 이더리움의 기존 인프라와 "너무 큰 차이"를 만들어냈다. 왜냐하면:

* 이더리움은 당시 "EOA만을 위한 서명 구조(ECDSA)"에 맞춰 설계되어 있었음
* EIP-86을 적용하려면 "프로토콜 레벨에서 코드 실행 기반 검증 구조로 전면 교체"해야함
* 이는 사실상 "하드포크 수준의 큰 변경"을 필요로 하며, 네트워크 전체의 합의가 필요한 작업임

결과적으로 EIP-86은 기술적 가능성을 보여준 데에는 의의가 있었지만, 현실적인 적용은 어려웠다. 


## 7. ERC-2938 (2020): 트랜잭션 타입의 진화

### 등장 배경

2017년의 EIP-86은 계정 추상화의 첫 시도였지만, 프로토콜 레벨에서 너무 많은 변경을 요구했다는 이유로 현실적인 채택이 어려웠다.
이후 "2020년", 보다 현실적인 방향으로 계정 추상화를 구현하려는 시도로 "ERC-2938"이 등장하게 된다.

이 제안은 "‘새로운 트랜잭션 타입’을 정의함으로써 계정 추상화를 실현"하고자 했다.

### 주요 아이디어

ERC-2938은 기존 트랜잭션에 다음과 같은 새로운 필드를 추가하자고 제안했다.

* `initCode`: 지갑이 어떤 로직을 기반으로 작동할 것인지 초기화 코드 제공
* `validationGas`: 해당 트랜잭션의 유효성 검사에 필요한 예상 가스량
* `paymaster`: 수수료를 대납할 주체를 지정하는 필드

그리고 트랜잭션 처리 과정에 "“VALIDATE 단계”"를 명확하게 도입하여, 스마트 월렛이 사용자 정의 로직을 직접 실행할 수 있도록 설계하였다. 이로써 트랜잭션 실행 이전에 "지갑이 직접 서명 유효성, 제한 정책 등을 확인"할 수 있게 된다.

### 기술적 의의

* 계정 추상화의 주요 기능인 "커스터마이징 가능 지갑"을 부분적으로 실현할 수 있는 구조
* 향후 다양한 스마트 월렛 UX를 구현하기 위한 기반 마련

ERC-2938 역시 현실적 채택에는 실패했다. 이유는 다음과 같다:

* 여전히 "트랜잭션 구조 자체를 바꾸는 프로토콜 레벨의 변경"이 필요함
* 이더리움 메인넷의 "하드포크가 필요"하며, 이는 생태계 전체 합의 없이는 추진이 어려움

결국 EIP-86보다는 현실적인 접근이었지만, 여전히 "“프로토콜 레벨 변경”이라는 본질적인 한계를 넘지 못한 제안"이었다.

## 8. ERC-4337 (2021): 하드포크 없는 계정 추상화

### ERC-4337 등장

"ERC-4337은 2021년에 등장한 계정 추상화 제안으로, 비탈릭 부테린과 6명의 공동 제안자들이 작성한 기술 표준이다."
이 제안은 앞선 두 제안(EIP-86, ERC-2938)과 달리, "하드포크 없이 계정 추상화를 구현할 수 있는 구조"를 목표로 한다.

즉, 기존 이더리움의 프로토콜(코어 레벨)을 변경하지 않고, "스마트 컨트랙트와 우회적인 구조를 통해 계정 추상화를 실현"하는 데 성공했다.

### 핵심 개념

ERC-4337에서는 기존의 트랜잭션이 아닌 "`UserOperation`이라는 구조체"를 사용한다. 그리고 이를 처리하기 위해 다음과 같은 새로운 구성 요소들이 등장한다:

| 구성 요소                      | 설명                                                           |
| -------------------------- | ------------------------------------------------------------ |
| "UserOperation"          | 사용자의 행동 요청. 보내려는 금액, 호출할 컨트랙트, 서명, 제한 정책 등의 정보를 포함           |
| "Bundler"                | 기존 채굴자 역할. 여러 UserOperation을 수집하고 실행 요청을 보낸다                 |
| "EntryPoint"             | 핵심 스마트 컨트랙트. UserOperation을 검증 및 실행하며, 추상화 로직을 중재한다          |
| "Smart Wallet"           | 사용자 정의 스마트 컨트랙트 기반 지갑. validateUserOp(), execute() 등의 로직을 수행 |
| "Paymaster / Aggregator" | 수수료 대납, 서명 통합 등의 역할을 담당하는 보조 컴포넌트                            |

이 구조를 통해 "트랜잭션이 아닌 UserOperation을 중심으로 동작하는 평행 메모풀(Alt Mempool)"을 구성하고, 일반 EOA와는 다른 방식으로 트랜잭션을 처리하게 된다.

---

## 9. 어떻게 동작하는가?

ERC-4337의 전체 동작 흐름은 다음과 같다:

1. 사용자가 스마트월렛 앱을 통해 ‘10 ETH 송신’ 버튼을 누름
2. 이 요청은 전통적인 트랜잭션이 아니라, `UserOperation`이라는 구조체로 만들어짐
3. UserOperation은 "Bundler"에게 전달됨
4. Bundler는 "EntryPoint" 스마트 컨트랙트의 `handleOps()` 함수를 호출함
5. EntryPoint는 내부적으로 Smart Wallet의 `validateUserOp()`와 `execute()` 함수를 호출함
6. Smart Wallet은 자체 로직에 따라 유효성을 검증하고, 조건이 만족되면 송금을 수행함

> 이 전체 과정은 "완전히 스마트 컨트랙트 기반으로 처리되며, 전통적인 트랜잭션 구조와는 별도로 동작"함

### 혁신 포인트

* 기존 계정과는 달리 "지갑 자체에 복잡한 로직을 내장"할 수 있음
* 서명 검증, 접근 제어, 송금 한도, 자동 이체, 수수료 정책 등을 "모두 스마트 컨트랙트로 제어"할 수 있음
* "하드포크 없이 구현 가능"하기 때문에, 개발자와 사용자 모두 빠르게 채택할 수 있음

---

# ERC-4337  : 가스비 대납, Paymaster 구조

## 10. Paymaster란 무엇인가?

### 기존의 문제: 가스비는 항상 사용자의 부담

기존의 EOA 기반 구조에서는 트랜잭션을 실행하기 위해 반드시 사용자가 본인의 지갑에 "ETH를 보유"하고 있어야 한다. 

* 아무리 토큰(USDT, USDC, NFT 등)을 많이 갖고 있더라도,
* 지갑에 "ETH가 없으면 아무런 작업도 수행할 수 없는 구조"였다.

이는 Web3 진입 장벽을 크게 높이는 원인 중 하나로 지목되어 왔다. 특히 신규 사용자나 토큰 위주로 활동하는 유저들에게는 "불합리한 UX"로 작용해 왔다.

> "내가 NFT를 샀는데, 전송하려면 또 ETH를 사야 해?"
> "지갑 만들자마자 가스비부터 충전해야 하는 건 너무 번거로워"

이러한 사용자들의 피로감을 해소하고자 등장한 개념이 "Paymaster"이다.

---

## 11. Paymaster의 구조와 역할

Paymaster는 "ERC-4337의 EntryPoint 컨트랙트 구조 안에서, 가스비를 대신 지불하는 역할"을 수행하는 특수한 스마트 컨트랙트이다.

### 동작 흐름

1. 사용자가 "Smart Wallet"을 통해 UserOperation을 생성한다.
   이 안에는 다음과 같은 필드가 포함된다.

   * 보내려는 금액
   * 호출할 컨트랙트 주소
   * 서명(Signature)
   * "paymasterAndData": Paymaster의 주소와 해당 대납 조건을 담은 데이터

2. 이 UserOperation은 Bundler를 통해 "EntryPoint"의 `handleOps()`로 전달된다.

3. EntryPoint는 다음 순서로 처리한다:

   * 먼저 Paymaster의 `validatePaymasterUserOp()` 함수를 호출하여 "조건을 검증"
   * 조건이 충족되면 가스비를 대신 지불
   * 이후 Smart Wallet의 `validateUserOp()`와 `execute()`가 순차적으로 호출된다

4. 최종적으로 "트랜잭션이 실행되며, 사용자는 ETH 없이도 기능을 사용할 수 있다."

---

## 12. 어떤 조건으로 대납이 가능한가?

Paymaster는 단순히 “무조건 가스비를 대주는 존재”가 아니다. 오히려 "정교하게 조건을 설정할 수 있는 필터 역할"을 하게 된다.
예를 들어 다음과 같은 조건을 설정할 수 있다.

* 특정 "NFT를 보유한 사용자"에게만 가스비 무료 혜택 제공
* 사용자 주소가 특정 "화이트리스트에 포함되어 있는 경우"에만 대납
* "IP 주소, 국가, 시간대"에 따라 허용 여부를 결정
* 프로모션 기간(예: 특정 날짜)에만 수수료 대납 허용
* 오라클을 통해 실시간 조건 검증 후 승인

이처럼 "Paymaster는 스마트 컨트랙트를 통한 수수료 정책 컨트롤러"로서, 대납 여부를 동적으로 판단하고 적용할 수 있다.

---

## 실제 사용 예시 흐름 (정리)

```plaintext
[사용자 → 스마트 월렛 앱에서 “10 ETH 전송” 버튼 클릭]
↓
[앱 → UserOperation 생성 (Paymaster 정보 포함)]
↓
[Bundler → EntryPoint에 handleOps() 요청]
↓
[EntryPoint → Paymaster.validatePaymasterUserOp() 호출]
↓
[조건 충족 → 가스비 대납]
↓
[EntryPoint → Smart Wallet의 validateUserOp() 및 execute() 실행]
↓
[트랜잭션 완료, 사용자 ETH 없이도 전송 성공]
```

---

## Paymaster가 바꾸는 Web3 UX

Paymaster 구조를 통해 다음과 같은 혁신적 UX 개선이 가능해진다.

| Before (기존)     | After (ERC-4337 + Paymaster)  |
| --------------- | ----------------------------- |
| ETH 없으면 아무것도 못함 | 토큰만 있어도 NFT 전송, 게임 실행 가능      |
| 신규 유저가 바로 진입 불가 | 가스비 무료 체험형 온보딩 가능             |
| 사용자가 모든 수수료 부담  | 프로젝트나 플랫폼에서 일부 또는 전부 대납 가능    |
| 수수료 제어 어려움      | 마케팅, 리워드 정책에 따라 유연한 수수료 전략 가능 |

즉, Paymaster는 Web3 UX를 "Web2 수준으로 끌어올릴 수 있는 핵심 요소"로 평가된다. 사용자는 "수수료라는 장벽 없이도 지갑을 사용하고, 스마트 컨트랙트를 체험할 수 있는" 구조를 갖추게 되는 것이다.

---

# ERC-4337 : 대규모 서명 검증을 가능케 하는 Aggregator 구조

## 13. Aggregator란 무엇인가?

ERC-4337 구조에서 다수의 사용자(User)가 동시에 블록에 트랜잭션을 제출하게 될 경우, 각각의 "UserOperation"은 모두 "서명 검증(validateUserOp())"을 거쳐야 한다.

하지만 이 과정은 상당한 "가스 비용"을 초래한다. 왜냐하면:

* 각 지갑이 사용하는 서명 알고리즘이 다르고,
* 각 트랜잭션마다 별도로 서명을 검증해야 하며,
* 검증 로직은 대부분 스마트 컨트랙트 내에서 수행되기 때문암.

> 이런 식으로 수백 개의 UserOperation이 개별적으로 검증된다면, 번들러(Bundler)는 수수료 부담 때문에 더 이상 묶어서 처리하기가 어렵다.

이 문제를 해결하기 위해 등장한 구조가 "Aggregator(집계자)"이다. Aggregator는 말 그대로 "다수의 서명을 모아 하나로 합성"하고, "한 번의 검증으로 여러 트랜잭션을 유효하다고 판단"하게 만들어주는 역할을 한다.

---

## 14. Aggregator의 핵심 아이디어

### 기존 방식 vs Aggregator 방식

| 기존 방식             | Aggregator 방식                  |
| ----------------- | ------------------------------ |
| 각 지갑이 개별 서명 검증 수행 | Aggregator가 서명들을 “합성”          |
| 가스비가 각각 소모됨       | 단 한 번의 검증으로 처리                 |
| 번들러가 모든 서명 확인 부담  | EntryPoint는 Aggregator만 호출하면 됨 |

이 구조에서는 EntryPoint가 SmartWallet의 validateUserOp()를 호출하는 대신,
→ "Aggregator의 validateSignatures()" 함수를 호출하여
→ 한꺼번에 여러 UserOperation의 유효성을 판단하게 된다.

즉, "서명 검증 책임을 Aggregator에게 위임"함으로써 "가스비 절약 + 처리 효율 향상"이라는 두 마리 토끼를 잡는 구조다.

---

## 15. 어떤 서명 알고리즘이 Aggregator에 적합한가?

Aggregator 구조를 제대로 활용하려면, 서명을 “합성(aggregation)”할 수 있는 서명 알고리즘이 필요하다. 일반적인 ECDSA나 RSA는 합성이 어렵기 때문에, 다음과 같은 "멀티서명/합성서명 친화적인 알고리즘"이 주목받는다.

### 대표적인 합성 서명 알고리즘

* "BLS (Boneh–Lynn–Shacham)"

  * 여러 서명을 단 하나의 서명으로 합칠 수 있는 구조
  * 한 번의 검증으로 n개의 서명 유효성을 입증 가능
  * 이더리움 2.0에서도 사용됨

* "Schnorr Signature"

  * 비트코인의 Taproot 업그레이드에서 채택된 구조
  * BLS보다 간단하지만, 서명 결합 및 검증이 효율적임

### 예시: BLS 기반 합성 서명

```plaintext
- 유저 A: 메시지 m1 → 서명 σ1
- 유저 B: 메시지 m2 → 서명 σ2
- 유저 C: 메시지 m3 → 서명 σ3
…
→ σ1 + σ2 + σ3 = σagg (합성 서명)

→ Aggregator가 σagg 하나만 EntryPoint에 제출
→ EntryPoint는 한 번의 검증으로 모든 UserOperation을 승인
```

이렇게 되면 번들러는 수십, 수백 개의 요청을 "가스비 부담 없이 한꺼번에 묶어서 블록에 포함"시킬 수 있다. 이는 "ERC-4337의 확장성(scalability)을 극적으로 향상"시켜주는 요소이다.

---

## Aggregator 도입의 효과

| 항목       | Aggregator 미사용 | Aggregator 사용 시 |
| -------- | -------------- | --------------- |
| 서명 검증 횟수 | N (사용자 수만큼)    | 1 (합성 서명 1회)    |
| 가스 비용    | 매우 높음          | 대폭 절감           |
| 확장성      | 제한적            | 수백 개 UserOp 가능  |

결론적으로 Aggregator는 ERC-4337이 실제 대규모 트랜잭션 환경에서도 사용 가능하도록 만들어주는 "핵심 컴포넌트"이다. 특히 디파이, 게임, 대중 지갑 서비스 등에서 "서명 부담을 최소화하면서 성능을 높이기 위한 필수 도구"로 활용될 수 있다.

---


# ERC-4337  : 가스비 증가 문제와 Layer 2 해법

## 16. ERC-4337의 현실적 한계: EOA 대비 높은 가스 소모

### 이상적 구조 vs 현실적 문제

ERC-4337은 사용자 경험(UX)을 획기적으로 개선할 수 있는 스마트 지갑 구조를 제안했지만, "현실적인 문제점"도 존재한다.
그 중 가장 두드러지는 단점은 바로 "높은 가스비(Gas Fee) 소모"이다.

기존 EOA 계정은 단순한 서명과 전송만 수행하면 되기 때문에, 가스 사용량이 비교적 적다. 하지만 ERC-4337은 다음과 같은 "복잡한 컨트랙트 호출 구조"를 가진다:

```
UserOperation
 → Bundler
   → EntryPoint.handleOps()
     → SmartWallet.validateUserOp()
       → SmartWallet.execute()
         → (선택) Paymaster.validatePaymasterUserOp()
         → (선택) Aggregator.validateSignatures()
```

이처럼 "여러 스마트 컨트랙트를 차례대로 호출"하다 보니, 그에 따라 "가스 사용량이 기하급수적으로 증가"하게 된다.

> ✅ 실제로는 EOA보다 최대 "2배 이상 가스가 더 소모"될 수 있다는 분석도 있다.

---

### 왜 그렇게 많은 가스가 들까?

1. "EntryPoint 호출 비용"

   * handleOps() 함수는 트랜잭션을 다중 검증하고, 스마트월렛의 validateUserOp와 execute를 모두 호출해야 함

2. "컨트랙트 중첩 구조"

   * EntryPoint → SmartWallet → 타 컨트랙트 호출로 이어지는 "계층형 호출"이 많음

3. "검증 절차 중복"

   * 서명 검증, Nonce 확인, 예치금 확인, 조건부 수수료 대납 등이 모두 "스마트 컨트랙트 내에서 수행"됨

이러한 구조로 인해, "단순한 “전송”을 하더라도 수많은 내부 연산"이 필요하며, 이는 곧 가스비 상승으로 이어진다.

---

## 17. 해결책: Rollup 기반 Layer 2의 도입

ERC-4337의 구조적 한계를 극복하기 위해 커뮤니티에서는 "Layer 2 솔루션과의 결합"을 중요한 대안으로 제시하고 있다.

### Layer 2란 무엇인가?

Layer 2는 이더리움 메인 체인(L1) 위에 존재하는 "보조 체인" 또는 "확장 체계"이다.
대부분의 연산을 L2에서 수행하고, 최종 결과만 L1에 기록함으로써,

* 가스비를 절감하고
* 처리 속도를 높이며
* 확장성을 향상시킬 수 있다.

### Rollup: 가장 유망한 L2 방식

그중에서도 "Rollup"은 가장 각광받는 L2 기술이다.

* Rollup은 수많은 트랜잭션을 "하나로 묶어(압축)"
* 이를 이더리움 메인넷에 "한 번에 업로드"함으로써
* 가스 비용을 대폭 줄이고,
* 동시에 "L1의 보안성"도 유지할 수 있는 기술이다.

---

### ERC-4337 + Rollup 구조

| 구성 요소                              | 설명                                          |
| ---------------------------------- | ------------------------------------------- |
| EntryPoint, SmartWallet, Paymaster | L2에서 동작함 (ZK Rollup or Optimistic Rollup 등) |
| Bundler                            | L2에서 UserOperation을 처리하고, EntryPoint에 제출    |
| 트랜잭션 실행                            | L2에서 수행됨 – 빠르고 저렴함                          |
| 트랜잭션 기록                            | L1에는 결과만 기록되어 보안성 유지                        |

이 구조를 통해 다음과 같은 장점이 생긴다:

* "EntryPoint, SmartWallet 등의 다중 호출 비용 제거"
  → L2에서 수행되므로 단가가 매우 저렴

* "수수료 대납 정책(Paymaster)"도 L2에서 유연하게 처리 가능
  → 즉시 응답, 오라클 연동 등 확장성 ↑

* "보안성은 유지하면서도 UX는 Web2 수준으로 개선"
  → 이더리움의 신뢰성 + 빠른 응답성이라는 조합

---

## 결론: ERC-4337은 단독으론 무겁지만, L2와 함께라면 진정한 UX 혁신 가능

ERC-4337은 Web3 지갑 UX를 재정의하는 설계이지만, 메인넷(L1) 단독으로는 가스비 문제로 현실적인 채택에 한계가 있다.
하지만 Rollup 기반 L2와 결합할 경우,

* 사용자에게는 "가볍고 직관적인 지갑 경험"을,
* 개발자에게는 "확장성 있고 정교한 컨트랙트 구조"를 제공할 수 있음.

결국 "ERC-4337은 L2 시대에 맞춰 진화할 준비가 된 설계"이며,
지갑, 디앱, 디파이 플랫폼, 게임 등 다양한 Web3 프로젝트에서 핵심 인프라로 자리잡을 가능성이 높다.

---

# ERC-4337  : 구현 시 반드시 고려해야 할 3가지 보안 포인트

ERC-4337은 계정 추상화를 실현하는 데 있어 "EntryPoint", "Smart Wallet", "UserOperation" 등 복잡한 구조를 활용한다.
이러한 구조 속에서 개발자 또는 지갑 서비스 운영자가 실수하게 되면 "보안 문제"나 "오작동"이 발생할 수 있다.
이번 파트에서는 "ERC-4337 구현 시 반드시 신경 써야 하는 3가지 핵심 포인트"를 다룬다.

---

## 18. 서명 검증은 반드시 SmartWallet 안에서 수행해야 한다

### 흔한 오해: EntryPoint에서 서명 검증하면 되지 않나?

EntryPoint는 UserOperation을 받아서 SmartWallet의 `validateUserOp()` 함수를 호출하는 "중재자" 역할을 한다.
하지만 중요한 점은, "EntryPoint는 아무나 호출할 수 있는 공개 컨트랙트"라는 것이다.
즉, 누구든지 EntryPoint를 통해 특정 SmartWallet을 실행하려고 시도할 수 있다.

> ✅ 따라서 "SmartWallet 내부에서 직접 서명 검증 로직을 포함하지 않으면",
> 악의적인 사용자가 유효한 시그니처 없이 트랜잭션을 실행시킬 수 있는 "우회 취약점"이 발생한다.

### 정리

* `validateUserOp()` 함수는 반드시 "SmartWallet에 구현"되어야 한다.
* 그 안에서 서명의 유효성, 정책 조건, 기타 사용자 정의 로직 등을 "철저히 검증"해야 한다.
* EntryPoint는 실행 트리거만 할 뿐, 실제 검증 책임은 SmartWallet에게 있다.

---

## 19. Nonce 검증은 SmartWallet에서 직접 수행해야 한다

ERC-4337에서는 트랜잭션을 “UserOperation” 단위로 처리한다.
그런데 EntryPoint는 "nonce(순서값)를 추적하지 않는다."

> 다시 말해, 동일한 UserOperation이 여러 번 전송되더라도 EntryPoint는 이를 중복 여부로 판단하지 못한다.

따라서 SmartWallet 내부에서 직접 nonce 값을 다음과 같이 관리해야 한다:

### 예시 로직

```solidity
mapping(address => uint256) public nonces;

function validateUserOp(UserOperation calldata op, ...) external {
    require(op.nonce == nonces[msg.sender], "Invalid nonce");
    nonces[msg.sender]++;
    ...
}
```

만약 이 로직이 없다면 다음과 같은 "Replay Attack"이 가능하다:

* 악의적인 번들러가 과거의 유효한 UserOperation을 다시 제출
* SmartWallet이 nonce 검증을 하지 않는다면 트랜잭션이 "다시 실행됨"
* 자산 탈취, 중복 결제 등의 위험 발생

### 정리

* ERC-4337에서 "Nonce 관리자는 SmartWallet이다."
* EntryPoint는 상태를 추적하지 않으며, "SmartWallet은 자체적으로 Nonce 상태값을 업데이트"해야 한다.

---

## 20. EntryPoint의 예치금 잔액을 항상 확인해야 한다

ERC-4337 구조에서 UserOperation을 처리하는 "Bundler는 선결제 구조"로 동작한다.
즉, Bundler는 먼저 트랜잭션을 제출하고, 나중에 가스비를 돌려받는 구조다.

> 그런데 만약 SmartWallet이 가스비를 지급할 만큼의 예치금이 없다면?
> 해당 트랜잭션은 중간에 실패하고, "Bundler만 손해를 보게 된다."

이 문제를 막기 위해 SmartWallet에서는 다음과 같은 로직이 반드시 필요하다:

### 예치금 확인 예시

```solidity
function validateUserOp(...) external returns (...) {
    require(address(this).balance >= op.maxFee, "Insufficient deposit");
    ...
}
```

또는 `deposit` 정보를 EntryPoint에서 확인하거나, `addDeposit()` 등 별도 예치 로직을 미리 호출해야 한다.

### 왜 중요할까?

* Bundler는 자발적으로 UserOperation을 모아서 실행한다.
* 그런데 "가스비를 먼저 부담"해야 하므로, "예치금이 없을 경우 해당 번들은 실패"한다.
* 이러한 실패는 네트워크 리소스를 낭비하고, 번들러 생태계의 참여도를 떨어뜨리는 원인이 된다.

---

## 총정리: 구현 체크리스트

| 체크포인트           | 구현 위치                     | 이유                    |
| --------------- | ------------------------- | --------------------- |
| 서명 검증           | SmartWallet 내부            | EntryPoint는 우회 가능성 있음 |
| Nonce 검증 및 업데이트 | SmartWallet 내부            | EntryPoint는 상태 추적 X   |
| 예치금 잔액 확인       | SmartWallet or EntryPoint | Bundler의 가스 손실 방지     |

> 이 세 가지는 "ERC-4337 스마트월렛 개발에서 반드시 체크해야 할 핵심 요소"이며,
> 하나라도 누락된다면 "재전송 공격, 인증 우회, 트랜잭션 실패" 등의 문제가 발생할 수 있다.

---

# ERC-4337  : Web3 지갑의 미래, 왜 ERC-4337인가?

## 21. 비탈릭이 말하는 Web3 지갑의 미래: 탈중앙 수수료 시장

이더리움 창시자인 "비탈릭 부테린(Vitalik Buterin)"은 ERC-4337 제안서와 여러 기술 인터뷰에서
"“탈중앙화된 수수료 시장(Decentralized Fee Market)”"의 중요성을 반복적으로 강조해 왔다.

### 기존 모델의 문제

기존의 Web3 지갑은 다음과 같은 "중앙집중적 설계"를 가지고 있다:

* 가스비는 "사용자 본인이 ETH로 지불"
* 검증자는 사실상 "메인넷 채굴자 또는 검증자 소수"
* 수수료 정책은 "고정적이며 사용자 맞춤이 불가능"
* 플랫폼이 비용을 조정하거나 사용자 조건에 따라 다르게 대우하기 어려움

이러한 구조에서는 "진입장벽이 높고, UX가 Web2 수준에 도달하기 어렵다."

---

### ERC-4337의 구조가 만들어내는 시장 변화

ERC-4337은 다음과 같은 "탈중앙 수수료 모델"을 현실화할 수 있다:

| 항목        | 기존 방식       | ERC-4337 방식                   |
| --------- | ----------- | ----------------------------- |
| 수수료 납부 주체 | 오직 사용자(EOA) | Paymaster, 플랫폼, 서드파티 등 다양한 주체 |
| 수수료 기준    | ETH 고정      | 조건 기반(보유 NFT, 주소, 위치 등)       |
| 검증자       | 채굴자/검증자     | 누구나 참여 가능한 Bundler 시장         |
| UX 설계     | 고정 구조       | 스마트 컨트랙트 기반 자유로운 설계           |

이러한 변화는 "“가스비는 당연히 내가 내는 것”"이라는 기존 인식을 깨고,
"“가스비도 플랫폼이 제공하는 서비스의 일부로서 유연하게 설계할 수 있다”"는 가능성을 제시한다.

즉, "사용자는 ETH가 없어도 Web3를 시작할 수 있고",
"프로젝트는 자신만의 수수료 정책을 설정함으로써 차별화된 사용자 경험을 제공"할 수 있다.

이전까지 Web3는 항상 기술 장벽으로 인해 “좋은 기술이지만 어렵다”는 한계를 갖고 있었다.
하지만 ERC-4337은 "그 장벽의 본질인 계정 구조 자체를 바꾸는 제안"이다.

결국 ERC-4337은 단순한 프로토콜이 아닌,
"“Web3를 누구나 사용할 수 있도록 만드는 구조적 진화”"라고 말할 수 있다.

---
